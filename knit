#!/usr/bin/env bash

Rmd=$PWD/$1
indir=`dirname $Rmd`
postname=`basename $1 .Rmd`
md="$indir/$postname.md"
rscript=$HOME/src/myknit.R 
jekylldir=${2:-$HOME/test/jekyll/test14}
category=$3
postdir=$jekylldir/$category/_posts
postmd="$postdir/$postname.md"
relRfigs=assets/R-figures
absRfigs=$jekylldir/$relRfigs
relfigdir=$relRfigs/$postname
absfigdir=$absRfigs/$postname

post2jekyll () {
    md=$1 postmd=$2 absfigdir=$3 relfigdir=$4
    Rmddir=`dirname $md`
    mv -f $md $postmd
    prefix="{{ site.baseurl }}/$relfigdir"
    # hack .md to fix its links to images
    sed -i "/plot of chunk/ s:figure:$prefix:" $postmd
    echo '<!-- MathJax scripts -->' >> $postmd
    echo '<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>' >> $postmd
    # write protection to emphasize that $postmd is generated by a script and not to be edited manually
    chmod -w $postmd
    test -d $absfigdir && rm -rf $absfigdir
    mv figure $absfigdir
    cd $Rmddir
    rm -rf figure && ln -s $absfigdir figure
}

# make output directories if necessary
test -d $postdir || mkdir -p $postdir
test -d $absRfigs || mkdir -p $absRfigs
tmpdir=`mktemp -d`
cd $tmpdir
#test -e figure && rm -rf figure

# knit the .Rmd to .md
if Rscript $rscript $Rmd && post2jekyll $md $postmd $absfigdir $relfigdir; then
    rm -rf $tmpdir
    cd $jekylldir && bundle exec jekyll build --incremental
else
    echo "`basename $0`: error; check $tmpdir for intermediate files" 1>&2
    exit 1
fi
