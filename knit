#!/usr/bin/env bash

# input args
Rmdpath=$1
jekylldir=${2:-$HOME/test/jekyll/test14}
relprojectdir=$3

# this generates an .md in the directory of the input .Rmd
knitrscript=$HOME/src/myknit.R 

# directory of input .Rmd; this will hold intermediate dirs and files
postname=`basename $Rmdpath .Rmd`
indir=`dirname $Rmdpath`
cd $indir || { echo "`basename $0`: could not locate directory $indir" 1>&2; exit 1; }
tmpdir=`mktemp -dp .` && cd $tmpdir
Rmd="../$postname.Rmd"
md="../$postname.md"

# make output directories if necessary
projectdir=$jekylldir/$relprojectdir
test -d $projectdir || { echo "`basename $0`: could not locate directory $projectdir" 1>&2; exit 1; }


# function that integrates newly generated .md and figures into jekyll site
post2jekyll () {
    md=$1 jekylldir=$2 relprojectdir=$3

    # set up paths and variables, ensure that dirs exist
    absprojectdir=$jekylldir/$relprojectdir
    postname=`basename $md .md`
    if test -z $relprojectdir; then
        relRdir=R/$postname
    else
        relRdir=$relprojectdir/R/$postname
    fi
    # absolute path to R-related or R-generated files and directories (e.g. .Rmd, 'figure')
    absRdir=$absprojectdir/R/$postname
    test -d $absRdir || mkdir -p $absRdir

    # subdirectory for figures with $absRdir
    relRfigdir=$relRdir/figure
    absRfigdir=$jekylldir/$relRfigdir
    # replace absRfigdir with the newly generated figure (if present)
    test -d $absRfigdir && rm -rf $absRfigdir
    if test -d figure; then
        mv figure $absRfigdir
        (cd `dirname $md` && rm -rf figure && ln -s $absRfigdir figure)
    fi

    # prepare and give the .md post to jekyll
    abspostdir=$absprojectdir/_posts
    test -d $abspostdir || mkdir -p $abspostdir
    postmd=$abspostdir/$postname.md
    mv -f $md $postmd
    # hack .md to fix its links to images
    prefix="{{ site.baseurl }}/$relRfigdir"
    sed -i "/plot of chunk/ s:figure:$prefix:" $postmd
    echo '<!-- MathJax scripts -->' >> $postmd
    echo '<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>' >> $postmd
    # write protection to emphasize that $postmd is generated by a script and not to be edited manually
    chmod -w $postmd
}

# knit the .Rmd to .md
if Rscript $knitrscript $Rmd && post2jekyll $md $jekylldir $relprojectdir; then
    rm -rf $tmpdir
    cd $jekylldir && bundle exec jekyll build --incremental
else
    echo "`basename $0`: error; check $tmpdir for intermediate files" 1>&2
    exit 1
fi
