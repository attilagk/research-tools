#! /usr/bin/env bash

# align, sort, index and merge a list of fastq files generated by X10

# The names of gzipped fastq files (*.fq.gz) are read from STDIN; it is
# convenient to store them in a file, for instance:
# $ find somedir -name 'sampleX*fq.gz' > sampleX-fastq-names
#
# The script assumes X10 fastq filenames with well defined fields.  It also
# assumes forward-reverse pairs of fastq files on the same path.

usage="`basename $0` -t nthreads -B sorted_indexed_merged_out.bam < fastq-names"

# process options
while getopts ":B:t:h" opt; do
    case $opt in
        B) BAM=$OPTARG;; # BAM output
        t) nthreads="$OPTARG";; # number of threads
        h) echo -e $usage 2>&1; exit ;;
    esac
done
shift $(($OPTIND - 1))
nthreads=${nthreads:-1}

if test -z $BAM ; then
    echo $usage; exit 1
fi

# tempfile holding names of fastq files for forward reads
fwfastqs=`mktemp`
grep '/.*_1\.fq\.gz' > $fwfastqs

# tempfile holding basenames
bnames=`mktemp`
sed 's/\(.*\)_1\.fq\.gz/\1/' $fwfastqs > $bnames
# tempfile holding names of bam files to be created
bams=`mktemp`
sed 's/\(.*\)/\1.bam/' $bnames > $bams
# tempfile holding names of bam index files to be created
bais=`mktemp`
sed 's/\(.*\)/\1.bam.bai/' $bnames > $bais

# aligns, sorts, and indexes a single pair of fw rev fastq files
align1pair () {
    bname=$1
    fwfq=${bname}_1.fq.gz 
    rgtags=`$HOME/bin/parseX10-fnames.1 $fwfq`
    align -t $nthreads -B ${bname}.bam $rgtags $fwfq ${bname}_2.fq.gz
}

# creates a sorted, indexed BAM for each pair
for bn in `cat $bnames`; do
    echo $bn
    align1pair $bn
done

# merge and index all BAMs and clean up
cat $bams | xargs samtools merge -@ $nthreads $BAM
samtools index $BAM && cat $bams | xargs rm && cat $bais | xargs rm

# clean up
rm $fwfastqs $bnames $bams $bais
